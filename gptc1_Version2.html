<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>dotdev fsa data build.</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg-main: #020617;
      --bg-panel: #0f172a;
      --bg-panel-soft: #111827;
      --border-subtle: #1f2937;
      --accent: #38bdf8;
      --accent-strong: #0ea5e9;
      --text-main: #e5e7eb;
      --text-muted: #9ca3af;
      --danger: #f97373;
      --danger-strong: #ef4444;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: radial-gradient(circle at top, #0b1120 0, #020617 55%, #000 100%);
      color: var(--text-main);
      min-height: 100vh;
      padding: 14px;
    }

    .app-shell {
      display: grid;
      grid-template-columns: minmax(0, 3fr) minmax(260px, 1.3fr);
      gap: 12px;
      align-items: flex-start;
    }
    @media (max-width: 1024px) { .app-shell { grid-template-columns: 1fr; } }

    .toolbox {
      background: var(--bg-panel);
      border-radius: 12px;
      padding: 10px 12px 12px;
      border: 1px solid var(--border-subtle);
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
      margin-bottom: 12px;
    }
    .toolbox-title {
      font-size: 13px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: var(--text-muted);
      margin-bottom: 8px;
      display: flex;
      justify-content: flex-start;
      align-items: center;
      gap: 10px;
    }
    .toolbox-title span.badge {
      font-size: 11px;
      padding: 2px 8px;
      border-radius: 999px;
      background: rgba(56, 189, 248, 0.12);
      color: var(--accent-strong);
      border: 1px solid rgba(56, 189, 248, 0.45);
    }

    .toolbar-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      align-items: center;
      margin-bottom: 6px;
    }
    .toolbar-row:last-child { margin-bottom: 0; }

    .pill-button {
      border-radius: 999px;
      padding: 5px 10px;
      font-size: 12px;
      border: 1px solid transparent;
      background: #1f2937;
      color: var(--text-main);
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      white-space: nowrap;
      transition: background 0.15s ease, border-color 0.15s ease, transform 0.05s ease;
    }
    .pill-button.primary {
      background: linear-gradient(135deg, var(--accent), var(--accent-strong));
      border-color: rgba(56, 189, 248, 0.45);
      color: #0b1120;
      font-weight: 600;
    }
    .pill-button.primary:hover { filter: brightness(1.08); transform: translateY(-0.5px); }
    .pill-button.danger {
      background: linear-gradient(135deg, var(--danger), var(--danger-strong));
      border-color: rgba(248, 113, 113, 0.8);
      color: #111827;
      font-weight: 600;
    }
    .pill-button.neutral { background: #111827; border-color: #374151; color: var(--text-main); }
    .pill-button:active { transform: translateY(0.4px) scale(0.99); }
    .pill-button:disabled { opacity: 0.5; cursor: default; transform: none; }

    .control-label {
      font-size: 11px;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.16em;
    }
    .control-group { display: flex; flex-direction: column; gap: 3px; margin-right: 10px; }
    .control-group input[type="text"] {
      font-size: 13px;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid #374151;
      background: #020617;
      color: var(--text-main);
      min-width: 160px;
    }
    .control-group input[type="text"]::placeholder { color: #6b7280; }

    /* Table pills */
    .table-pills-container {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
      padding: 6px 8px;
      font-size: 12px;
      background: radial-gradient(circle at left, rgba(56, 189, 248, 0.12), transparent 70%);
      border-bottom: 1px solid rgba(55, 65, 81, 0.9);
    }
    .data-pill {
      border-radius: 999px;
      padding: 4px 10px;
      font-size: 11px;
      background: rgba(15, 23, 42, 0.8);
      border: 1px solid #374151;
      color: var(--text-muted);
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }
    .data-pill .count { color: var(--accent-strong); font-weight: 600; margin-left: 2px; }
    .data-pills-container { display: none; }

    .main-panel {
      background: var(--bg-panel);
      border-radius: 12px;
      padding: 10px;
      border: 1px solid var(--border-subtle);
      box-shadow: 0 16px 40px rgba(0, 0, 0, 0.45);
      overflow: hidden;
    }
    .table-wrapper {
      border-radius: 10px;
      border: 1px solid var(--border-subtle);
      background: radial-gradient(circle at top left, #111827 0, #020617 52%);
      overflow: hidden;
    }
    table { border-collapse: collapse; width: 100%; font-size: 12px; table-layout: fixed; }
    thead {
      background: linear-gradient(to right, rgba(31, 41, 55, 0.95), rgba(15, 23, 42, 0.95));
      position: sticky; top: 0; z-index: 5;
    }
    thead tr { border-bottom: 1px solid rgba(55, 65, 81, 0.9); }
    th, td { padding: 4px 6px; border-bottom: 1px solid #111827; text-align: left; color: var(--text-main); }
    th {
      font-size: 11px; text-transform: uppercase; letter-spacing: 0.12em;
      color: var(--text-muted); white-space: nowrap;
    }
    td input[type="text"] {
      width: 100%; padding: 2px 4px; font-size: 12px;
      border-radius: 6px; border: 1px solid #374151; background: #020617; color: var(--text-main);
    }
    td textarea {
      width: 100%; min-height: 40px; resize: vertical; font-size: 12px;
      padding: 3px 4px; border-radius: 6px; border: 1px solid #374151; background: #020617; color: var(--text-main);
    }
    tbody tr:nth-child(even) { background: rgba(15, 23, 42, 0.85); }
    tbody tr:nth-child(odd) { background: rgba(15, 23, 42, 0.7); }
    tbody tr:hover { background: rgba(30, 64, 175, 0.4); }
    .table-container { max-height: 560px; overflow: auto; }

    .side-panel {
      background: var(--bg-panel);
      border-radius: 12px;
      padding: 10px;
      border: 1px solid var(--border-subtle);
      box-shadow: 0 16px 40px rgba(0, 0, 0, 0.45);
      display: grid; grid-template-rows: auto auto minmax(0, 1fr);
      gap: 10px; max-height: 100%;
    }
    .side-card { background: var(--bg-panel-soft); border-radius: 10px; padding: 8px 9px; border: 1px solid var(--border-subtle); }
    .side-card h3 { margin: 0 0 4px; font-size: 13px; letter-spacing: 0.08em; text-transform: uppercase; color: var(--text-muted); }
    .side-card p { margin: 0; font-size: 12px; color: var(--text-muted); }

    .log-box {
      background: #020617; border-radius: 8px; border: 1px solid #111827; padding: 6px;
      font-size: 11px; max-height: 6.5em; overflow: auto; color: var(--text-muted);
      white-space: pre-line; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace;
    }
    .log-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px; font-size: 11px; color: var(--text-muted); }
    .badge-small { font-size: 10px; padding: 1px 6px; border-radius: 999px; background: rgba(15, 23, 42, 0.9); border: 1px solid #374151; text-transform: uppercase; letter-spacing: 0.12em; }
    .log-entries-count { color: var(--accent-strong); font-weight: 600; }
    .log-clear-btn {
      border-radius: 999px; padding: 3px 8px; font-size: 11px;
      border: 1px solid rgba(248, 113, 113, 0.7);
      background: linear-gradient(135deg, #f97373, #ef4444); color: #111827; cursor: pointer;
    }
    .log-clear-btn:hover { filter: brightness(1.08); }
    .log-header-buttons { display: flex; gap: 4px; align-items: center; justify-content: flex-start; }
    .log-save-btn, .log-load-btn {
      border-radius: 999px; padding: 3px 8px; font-size: 11px;
      border: 1px solid rgba(56, 189, 248, 0.45);
      background: linear-gradient(135deg, #38bdf8, #0ea5e9);
      color: #0b1120; cursor: pointer; font-weight: 600;
    }
    .log-aux-btn { border-radius: 999px; padding: 3px 8px; font-size: 11px; border: 1px solid #374151; background: #111827; color: var(--text-main); cursor: pointer; }
    .log-aux-btn:hover { filter: brightness(1.08); }

    .help-list { margin: 0; padding-left: 16px; font-size: 11px; color: var(--text-muted); }
    .help-list li { margin-bottom: 3px; }
    code {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace;
      font-size: 11px; background: #020617; padding: 2px 4px; border-radius: 4px; border: 1px solid #1f2937;
    }

    /* Recall list to the right of import recall button */
    .recall-list {
      margin-left: 8px;
      padding: 6px;
      min-width: 140px;
      max-width: 340px;
      max-height: 120px;
      overflow: auto;
      background: linear-gradient(180deg, rgba(14,23,42,0.6), rgba(2,6,23,0.6));
      border: 1px solid rgba(56,189,248,0.08);
      border-radius: 8px;
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }
    .recall-item {
      background: rgba(15,23,42,0.8);
      border: 1px solid #374151;
      padding: 4px 8px;
      border-radius: 999px;
      font-size: 12px;
      color: var(--text-muted);
      cursor: pointer;
    }
    .recall-item:hover { background: rgba(56,189,248,0.12); color: var(--accent-strong); }

    .loading-status {
      font-size: 12px; color: var(--text-muted); margin-top: 6px;
      background: rgba(2,6,23,0.7); padding: 6px; border-radius: 8px; border: 1px solid #111827;
    }

    .row-highlight {
      box-shadow: inset 0 0 0 2px rgba(56,189,248,0.12);
      animation: fadeHighlight 2s ease-out;
    }
    @keyframes fadeHighlight {
      0% { background-color: rgba(56,189,248,0.18); }
      100% { background-color: transparent; }
    }

    .last-change-pill {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(56, 189, 248, 0.08);
      color: var(--accent-strong);
      border: 1px solid rgba(56,189,248,0.22);
      font-size: 12px;
      font-weight: 600;
    }
  </style>
</head>
<body>
  <div class="app-shell">
    <div>
      <div class="toolbox">
        <div class="toolbox-title">
          <span class="badge">DOT fsa money snatcher tools v4.7</span>
        </div>

        <!-- Row 1: file + basic controls -->
        <div class="toolbar-row">
          <button id="load-xls-btn" class="pill-button primary">Load FSA list (.xls/.csv)</button>
          <button id="clear-all-btn" class="pill-button danger">Clear ALL Data</button>
          <button id="kill-dups-btn" class="pill-button danger">Kill dups</button>
          <button id="save-table-btn" class="pill-button primary">Save table</button>
          <button id="load-table-btn" class="pill-button primary">Load table</button>
        </div>

        <!-- Row 2: mailer + filters + NEW importers -->
        <div class="toolbar-row">
          <button id="load-mailer-txt-btn" class="pill-button primary">Load Mailer .TXT</button>
          <button id="build-snailer-btn" class="pill-button primary" disabled>Build snailer</button>

          <div class="control-group" style="flex-direction:row;align-items:center;">
            <div style="display:flex;flex-direction:column;">
              <span class="control-label">Kill name:</span>
              <input type="text" id="kill-name-input" value="LKQ CORPORATION" />
            </div>
            <button id="kill-lkq-btn" class="pill-button danger" title="Kill matching names" style="margin-left:8px;min-width:36px;padding:5px 8px;">X</button>
          </div>

          <!-- NEW: split import buttons -->
          <button id="import-phone-btn" class="pill-button primary">Import Phone</button>
          <input id="import-phone-input" type="file"
                 accept=".csv,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet,application/vnd.ms-excel"
                 style="display:none" />

          <button id="import-email-btn" class="pill-button primary">Import Email</button>
          <input id="import-email-input" type="file"
                 accept=".csv,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet,application/vnd.ms-excel"
                 style="display:none" />

          <button id="import-recall-btn" class="pill-button primary">Import recall info</button>
          <input id="import-recall-input" type="file" accept=".json,application/json" style="display:none" />
          <div id="recall-list" class="recall-list" title="Click a recall code to jump to rows"></div>
        </div>

        <!-- Row 3: recall filter, geo groups, Fire email list -->
        <div class="toolbar-row">
          <div class="control-group">
            <span class="control-label">Recall filter:</span>
            <input type="text" id="recall-filter-input" placeholder="e.g. 24S02 or just '24S'" />
          </div>
          <button id="apply-recall-filter-btn" class="pill-button primary">Apply</button>
          <button id="reset-recall-filter-btn" class="pill-button danger">Reset</button>

          <button id="geo-groups-btn" class="pill-button primary">Sort by ZIP</button>
          <button id="fire-email-list-btn" class="pill-button primary">Fire email list</button>
        </div>

        <!-- Hidden mailer TXT input -->
        <input type="file" id="mailer-txt-input" accept=".txt,text/plain" style="display:none" />
      </div>
    </div>

    <!-- Log / helper side panel -->
    <div class="side-panel">
      <div class="side-card">
        <h3>Status</h3>
        <div style="display:flex;flex-direction:column;gap:8px;">
          <div class="last-change-pill" id="last-change-pill">Last state change: --/--/--</div>
          <p id="status-line">Ready.</p>
        </div>
      </div>

      <div class="side-card">
        <div class="log-header">
          <span class="badge-small">Log entries: <span id="log-count" class="log-entries-count">0</span></span>
          <div class="log-header-buttons">
            <button id="log-save-btn" class="log-save-btn">Save log</button>
            <button id="log-load-btn" class="log-load-btn">Load log</button>
            <button id="clear-log-btn" class="log-clear-btn">Clear log</button>
          </div>
        </div>
        <div id="log-box" class="log-box"></div>
      </div>

      <div class="side-card">
        <div class="loading-status" id="loading-status">No files uploading currently.  Idle.</div>
      </div>
    </div>
  </div>

  <div class="main-panel">
    <div class="table-wrapper">
      <div class="table-pills-container" id="table-pills">
        <div class="data-pill" id="pill-total">Total: <span class="count">0</span></div>
        <div class="data-pill" id="pill-addresses">Addresses: <span class="count">0</span></div>
        <div class="data-pill" id="pill-emails">Emails: <span class="count">0</span></div>
        <div class="data-pill" id="pill-phones">Phones: <span class="count">0</span></div>
        <div class="data-pill" id="pill-unique-recalls">Unique recalls: <span class="count">0</span></div>
      </div>
      <div class="table-container">
        <table>
          <thead>
            <tr>
              <th style="width: 130px;">VIN</th>
              <th style="width: 120px;">Year / Model</th>
              <th style="width: 150px;">Name</th>
              <th style="width: 150px;">Phone</th>
              <th style="width: 180px;">Email</th>
              <th style="width: 260px;">Address</th>
              <th style="width: 150px;">Recalls</th>
              <th style="width: 80px;">HAS</th>
              <th style="width: 80px;">Max HR</th>
              <th style="width: 180px;">Notes</th>
            </tr>
          </thead>
          <tbody id="table-body"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- XLSX + jsPDF libs -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <script>
    // Globals
    let rowsAll = [];
    let filteredRows = null;
    let recallFilterValue = '';
    let mailerTemplateText = '';
    window.recallInfoCache = null; // holds imported recall JSON for later use
    window.recallMapByVin = new Map(); // optional mapping vin -> info

    function getActiveRows() { return filteredRows !== null ? filteredRows : rowsAll; }

    // Loading UI
    function setLoading(fileName, percent) {
      const el = document.getElementById('loading-status');
      if (!el) return;
      if (fileName) {
        const nameOnly = fileName.split(/[/\\]/).pop();
        const pct = (typeof percent === 'number') ? ` [processed ${Math.round(percent)}% of file]` : '';
        el.textContent = `Loading file: ${nameOnly}${pct}`;
      } else {
        el.textContent = 'File loaded successfully.  Waiting for next....';
      }
    }
    function clearLoading() { setLoading('', 0); }

    // Last state change
    function formatDateShort(d) {
      const mm = String(d.getMonth() + 1).padStart(2, '0');
      const dd = String(d.getDate()).padStart(2, '0');
      const yy = String(d.getFullYear()).slice(-2);
      return `${mm}/${dd}/${yy}`;
    }
    function formatTimeSimple(d) {
      let h = d.getHours();
      const m = String(d.getMinutes()).padStart(2, '0');
      const ampm = h >= 12 ? 'pm' : 'am';
      h = h % 12; if (h === 0) h = 12;
      return `${h}:${m}${ampm}`;
    }
    function updateLastChangeTimestamp() {
      const el = document.getElementById('last-change-pill');
      if (!el) return;
      const now = new Date();
      el.textContent = `Last state change: ${formatDateShort(now)} ${formatTimeSimple(now)}`;
    }

    // Stats pills
    function updateDataPills() {
      const activeRows = getActiveRows();
      const total = activeRows.length;
      const withAddress = activeRows.filter(r => (r.address || '').trim()).length;
      const withEmail = activeRows.filter(r => (r.emailStr || '').trim()).length;
      const withPhone = activeRows.filter(r => (r.phoneStr || '').trim()).length;

      // Unique recall codes across active rows
      const codeSet = new Set();
      const codeRe = /\b\d{2}[A-Z]\d{2}\b/ig;
      for (const r of activeRows) {
        const text = r.recalls || '';
        const matches = text.match(codeRe);
        if (matches) matches.forEach(c => codeSet.add(c.toUpperCase()));
      }

      document.getElementById('pill-total').innerHTML = `Total: <span class="count">${total}</span>`;
      document.getElementById('pill-addresses').innerHTML = `Addresses: <span class="count">${withAddress}</span>`;
      document.getElementById('pill-emails').innerHTML = `Emails: <span class="count">${withEmail}</span>`;
      document.getElementById('pill-phones').innerHTML = `Phones: <span class="count">${withPhone}</span>`;
      document.getElementById('pill-unique-recalls').innerHTML = `Unique recalls: <span class="count">${codeSet.size}</span>`;
    }

    function logStatistics() {
      const activeRows = getActiveRows();
      const total = activeRows.length;
      const withAddress = activeRows.filter(r => (r.address || '').trim()).length;
      const withEmail = activeRows.filter(r => (r.emailStr || '').trim()).length;
      const withPhone = activeRows.filter(r => (r.phoneStr || '').trim()).length;
      const msg = [`Currently loaded: ${total}`, `With addresses: ${withAddress}`, `With phone: ${withPhone}`, `With email: ${withEmail}`].join('\n');
      log(msg);
    }

    function stampedPrefix() {
      const now = new Date();
      return `[${formatDateShort(now)}][${formatTimeSimple(now)}]: `;
    }

    function log(message) {
      const box = document.getElementById('log-box');
      const countEl = document.getElementById('log-count');
      const statusEl = document.getElementById('status-line');
      if (!box) return;
      const line = stampedPrefix() + message;
      box.textContent += (box.textContent ? '\n' : '') + line;
      box.scrollTop = box.scrollHeight;
      if (countEl) { const current = parseInt(countEl.textContent || '0', 10) || 0; countEl.textContent = current + 1; }
      if (statusEl) statusEl.textContent = message;
      updateLastChangeTimestamp();
    }
    function clearLog() {
      const box = document.getElementById('log-box');
      const countEl = document.getElementById('log-count');
      const statusEl = document.getElementById('status-line');
      if (box) box.textContent = '';
      if (countEl) countEl.textContent = '0';
      if (statusEl) statusEl.textContent = 'Log cleared.';
      updateLastChangeTimestamp();
    }

    function saveLog() {
      const box = document.getElementById('log-box'); if (!box) return;
      const blob = new Blob([box.textContent], { type: 'text/plain' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      const ts = new Date().toISOString().replace(/[:.]/g, '-');
      a.href = url; a.download = `log_${ts}.txt`; document.body.appendChild(a); a.click();
      document.body.removeChild(a); URL.revokeObjectURL(url); log('Log saved to file.');
    }
    function loadLog() {
      const input = document.createElement('input');
      input.type = 'file'; input.accept = '.txt,text/plain';
      input.addEventListener('change', e => {
        const file = e.target.files[0]; if (!file) return;
        const reader = new FileReader();
        reader.onload = ev => {
          const content = ev.target.result;
          const box = document.getElementById('log-box');
          if (box) {
            box.textContent = content;
            const lines = content.split('\n').filter(x => x.trim().length > 0);
            document.getElementById('log-count').textContent = lines.length;
            log('Log loaded from file.');
          }
        };
        reader.readAsText(file);
      });
      input.click();
    }

    async function copyToClipboard(text) {
      if (!text) return;
      try {
        if (navigator.clipboard && navigator.clipboard.writeText) { await navigator.clipboard.writeText(text); }
        else throw new Error('No clipboard API');
        log(`Copied VIN "${text}" to clipboard.`);
      } catch (err) {
        try {
          const textarea = document.createElement('textarea');
          textarea.style.position = 'fixed'; textarea.style.left = '-9999px'; textarea.value = text;
          document.body.appendChild(textarea); textarea.select(); document.execCommand('copy'); document.body.removeChild(textarea);
          log(`Copied VIN "${text}" to clipboard (fallback).`);
        } catch { log('Clipboard copy failed; please copy manually.'); }
      }
    }

    function applyRecallInfoToRows() {
      // Build vin lookup if recallInfoCache contains vin keyed entries
      window.recallMapByVin = new Map();
      const cache = window.recallInfoCache;
      if (!cache) return;
      if (Array.isArray(cache)) {
        cache.forEach(item => {
          if (!item) return;
          // Accept multiple shapes: item.vin, item.VIN, item.vinFull, item.vin_number
          const vinKeyCandidates = ['vin', 'VIN', 'vinFull', 'vin_full', 'v'];
          for (const key of vinKeyCandidates) {
            if (item[key]) {
              const clean = String(item[key] || '').toUpperCase().replace(/[^A-Z0-9]/g, '');
              if (clean) { window.recallMapByVin.set(clean.slice(-17), item); break; }
            }
          }
        });
      } else if (typeof cache === 'object') {
        // if object keyed by VIN
        Object.keys(cache).forEach(k => {
          const clean = String(k || '').toUpperCase().replace(/[^A-Z0-9]/g, '');
          if (clean) window.recallMapByVin.set(clean.slice(-17), cache[k]);
        });
      }

      // Apply mapping onto rows
      rowsAll.forEach(row => {
        const vinKey = String(row.vinFull || '').toUpperCase().replace(/[^A-Z0-9]/g, '').slice(-17);
        const info = window.recallMapByVin.get(vinKey);
        if (info) {
          // prefer info.maxHR if present, else try to find from recalls mapping
          row.maxHR = (info.maxHR || info.maxHr || info.max_h || '') + '';
        } else {
          // If not by VIN, attempt to lookup by matching any recall code in the cache list (if cache is array keyed by recall)
          if (Array.isArray(cache)) {
            // try to find first recall code in row.recalls that exists in cache by recall field
            const codes = (row.recalls || '').split('/').map(s => s.trim().toUpperCase()).filter(Boolean);
            for (const code of codes) {
              const match = cache.find(ci => (ci && String(ci.recall || '').toUpperCase()) === code);
              if (match && match.maxHR) { row.maxHR = (match.maxHR || '') + ''; break; }
            }
          }
        }
        // always set recallsCount
        row.recallsCount = (row.recalls && row.recalls.trim()) ? row.recalls.split('/').map(s => s.trim()).filter(Boolean).length : 0;
      });
    }

    function renderTable() {
      const tbody = document.getElementById('table-body');
      if (!tbody) return;
      const rows = getActiveRows();
      tbody.innerHTML = '';
      rows.forEach((row, rowIndex) => {
        const tr = document.createElement('tr');

        const tdVin = document.createElement('td');
        tdVin.textContent = row.vinFull || '';
        tdVin.style.cursor = 'pointer'; tdVin.title = 'Click to copy VIN';
        tdVin.addEventListener('click', () => copyToClipboard(row.vinFull));
        tr.appendChild(tdVin);

        const tdYrModel = document.createElement('td'); tdYrModel.textContent = row.yrModel || ''; tr.appendChild(tdYrModel);

        const tdName = document.createElement('td');
        const inputName = document.createElement('input'); inputName.type = 'text'; inputName.value = row.fullName || '';
        inputName.addEventListener('change', (e) => { row.fullName = e.target.value; row.hasName = !!(row.fullName && row.fullName.trim().length > 0); });
        tdName.appendChild(inputName); tr.appendChild(tdName);

        const tdPhone = document.createElement('td');
        const inputPhone = document.createElement('input'); inputPhone.type = 'text'; inputPhone.value = row.phoneStr || '';
        inputPhone.addEventListener('change', (e) => { row.phoneStr = e.target.value; });
        tdPhone.appendChild(inputPhone); tr.appendChild(tdPhone);

        const tdEmail = document.createElement('td');
        const inputEmail = document.createElement('input'); inputEmail.type = 'text'; inputEmail.value = row.emailStr || '';
        inputEmail.addEventListener('change', (e) => { row.emailStr = e.target.value; });
        tdEmail.appendChild(inputEmail); tr.appendChild(tdEmail);

        const tdAddr = document.createElement('td');
        const txtAddr = document.createElement('textarea'); txtAddr.value = row.address || '';
        txtAddr.addEventListener('change', (e) => { row.address = e.target.value; });
        tdAddr.appendChild(txtAddr); tr.appendChild(tdAddr);

        const tdRecalls = document.createElement('td');
        const inputRecalls = document.createElement('input'); inputRecalls.type = 'text'; inputRecalls.value = row.recalls || '';
        inputRecalls.addEventListener('change', (e) => { row.recalls = e.target.value; row.recallsCount = (row.recalls && row.recalls.trim()) ? row.recalls.split('/').map(s => s.trim()).filter(Boolean).length : 0; updateDataPills(); });
        tdRecalls.appendChild(inputRecalls); tr.appendChild(tdRecalls);

        const tdRecCount = document.createElement('td');
        tdRecCount.textContent = (typeof row.recallsCount !== 'undefined') ? String(row.recallsCount) : ((row.recalls && row.recalls.trim()) ? String(row.recalls.split('/').map(s => s.trim()).filter(Boolean).length) : '0');
        tr.appendChild(tdRecCount);

        const tdMaxHR = document.createElement('td');
        tdMaxHR.textContent = row.maxHR || '';
        tr.appendChild(tdMaxHR);

        const tdNotes = document.createElement('td');
        const txtNotes = document.createElement('textarea'); txtNotes.value = row.notes || '';
        txtNotes.addEventListener('change', (e) => { row.notes = e.target.value; });
        tdNotes.appendChild(txtNotes); tr.appendChild(tdNotes);

        tbody.appendChild(tr);
      });
      updateDataPills();
    }

    function syncTableEditsToRowsAll() {
      const tbody = document.getElementById('table-body'); if (!tbody) return;
      const trs = Array.from(tbody.querySelectorAll('tr'));
      const activeRows = getActiveRows(); if (trs.length !== activeRows.length) return;

      trs.forEach((tr, idx) => {
        const row = activeRows[idx]; if (!row) return;
        const tds = tr.querySelectorAll('td'); if (tds.length < 10) return;
        const nameInput = tds[2].querySelector('input'); if (nameInput) { row.fullName = nameInput.value; row.hasName = !!(row.fullName && row.fullName.trim().length > 0); }
        const phoneInput = tds[3].querySelector('input'); if (phoneInput) row.phoneStr = phoneInput.value;
        const emailInput = tds[4].querySelector('input'); if (emailInput) row.emailStr = emailInput.value;
        const addrText = tds[5].querySelector('textarea'); if (addrText) row.address = addrText.value;
        const recallInput = tds[6].querySelector('input'); if (recallInput) { row.recalls = recallInput.value; row.recallsCount = (row.recalls && row.recalls.trim()) ? row.recalls.split('/').map(s => s.trim()).filter(Boolean).length : 0; }
        const notesText = tds[9].querySelector('textarea'); if (notesText) row.notes = notesText.value;
      });
    }

    function addRowFromCells(row) {
      const cells = row.slice();
      const neededCols = 42; for (let i = 0; i < neededCols; i++) if (typeof cells[i] === 'undefined') cells[i] = '';

      let vinFull = String(cells[0] || '').replace(/^\uFEFF/, '').trim();
      if (!vinFull) return;
      if (vinFull.toUpperCase() === 'VIN' || vinFull === 'ï»¿') return;

      const modelYear = String(cells[2] || '').trim();
      const vehicleLineRaw = String(cells[1] || '').trim();
      let modelName = '';
      if (vehicleLineRaw) {
        let tokens = vehicleLineRaw.split(/\s+/).filter(Boolean);
        while (tokens.length && ['FORD', 'LINCOLN', 'MERCURY'].includes(tokens[0].toUpperCase())) tokens.shift();
        if (tokens.length) { const first = tokens[0]; modelName = first.charAt(0).toUpperCase() + first.slice(1).toLowerCase(); }
      }
      const yrModel = [modelYear, modelName].filter(Boolean).join(' ');

      const nameParts = [cells[3], cells[4], cells[5]].map(v => String(v || '').trim()).filter(Boolean);
      const hasName = nameParts.length > 0;
      const fullName = hasName ? nameParts.join(' ') : '';

      const phoneIdxs = [6, 8, 10, 12, 14];
      const emailIdxs = [7, 9, 11, 13, 15];
      const phones = phoneIdxs.map(i => String(cells[i] || '').trim()).filter(v => v.length > 0);
      const emails = emailIdxs.map(i => String(cells[i] || '').trim()).filter(v => v.length > 0);
      const phoneStr = phones.join(' / ');
      const emailStr = emails.join(' / ');

      const addrLines = [String(cells[16] || '').trim(), String(cells[17] || '').trim(), String(cells[18] || '').trim(), String(cells[19] || '').trim()].filter(v => v.length > 0);
      const addrLine = addrLines.join(' ').trim();
      const city = String(cells[20] || '').trim();
      const state = String(cells[21] || '').trim();
      const zip = String(cells[22] || '').trim();
      let cityStateZip = ''; if (city) cityStateZip = city; if (state) cityStateZip += (cityStateZip ? ' ' : '') + state; if (zip) cityStateZip += (cityStateZip ? ' ' : '') + zip;
      let address = ''; if (addrLine && cityStateZip) address = addrLine + ', ' + cityStateZip; else if (addrLine) address = addrLine; else address = cityStateZip;

      const fsaIdxs = [24, 26, 28, 30, 32, 34, 36, 38, 40];
      const fsaValues = fsaIdxs.map(i => String(cells[i] || '').trim()).filter(v => v.length > 0);
      const recalls = fsaValues.join(' / ');
      const wantedPattern = /\d{2}[SEC]\d{2}/i;
      const hasWantedFsa = fsaValues.some(code => wantedPattern.test(code));
      if (!hasWantedFsa) return;

      const rowObj = { vinFull, yrModel, fullName, phoneStr, emailStr, address, recalls, notes: '', hasName };
      // set recallsCount
      rowObj.recallsCount = (recalls && recalls.trim()) ? recalls.split('/').map(s => s.trim()).filter(Boolean).length : 0;
      // attempt to set maxHR from recallInfoCache if available
      rowsAll.push(rowObj);
    }

    function parseRows(rows) {
      setLoading('sheet', 0);
      const before = rowsAll.length;
      for (let i = 0; i < rows.length; i++) {
        addRowFromCells(rows[i]);
        if (i % 50 === 0) setLoading('sheet', (i / rows.length) * 100);
      }
      // apply recall info if available
      applyRecallInfoToRows();
      clearLoading();
      const added = rowsAll.length - before;
      log(`Parsed ${added} rows into table. Total rows: ${rowsAll.length}.`);
      logStatistics();
    }

    function parseCsvText(text) {
      const lines = text.split(/\r?\n/);
      const rows = [];
      for (let line of lines) {
        if (!line || !line.trim()) continue;
        // naive CSV split (user indicated their files work with current implementation)
        const cells = line.split(',');
        rows.push(cells);
      }
      return rows;
    }

    function handleFile(file) {
      const name = file.name.toLowerCase();
      const reader = new FileReader();
      setLoading(file.name, 0);
      reader.onprogress = (e) => { if (e.lengthComputable) setLoading(file.name, (e.loaded / e.total) * 100); };
      if (name.endsWith('.csv')) {
        reader.onload = (e) => { try { const text = e.target.result; const rows = parseCsvText(text); parseRows(rows); renderTable(); } catch (err) { console.error(err); log('Error reading CSV file (see console).'); } };
        reader.onloadend = () => clearLoading();
        reader.readAsText(file);
      } else {
        reader.onload = (e) => {
          try {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, { type: 'array' });
            const firstSheetName = workbook.SheetNames[0];
            const worksheet = workbook.Sheets[firstSheetName];
            const sheetJson = XLSX.utils.sheet_to_json(worksheet, { header: 1, defval: '' });
            parseRows(sheetJson); renderTable();
          } catch (err) { console.error(err); log('Error reading XLS/XLSX file (see console).'); }
        };
        reader.onloadend = () => clearLoading();
        reader.onprogress = (e) => { if (e.lengthComputable) setLoading(file.name, (e.loaded / e.total) * 100); };
        reader.readAsArrayBuffer(file);
      }
    }

    function killDuplicates() {
      syncTableEditsToRowsAll();
      const map = new Map(); const deduped = [];
      rowsAll.forEach(row => {
        const key = row.vinFull.toUpperCase().replace(/[^A-Z0-9]/g, '');
        if (!key) return; if (!map.has(key)) { map.set(key, true); deduped.push(row); }
      });
      const removed = rowsAll.length - deduped.length;
      rowsAll = deduped; filteredRows = null; recallFilterValue = '';
      log(`Kill dups: removed ${removed} duplicate VIN(s).`); renderTable();
    }

    function saveTable() {
      syncTableEditsToRowsAll();
      const payload = rowsAll.map(row => ({
        vinFull: row.vinFull, yrModel: row.yrModel, fullName: row.fullName, phoneStr: row.phoneStr,
        emailStr: row.emailStr, address: row.address, recalls: row.recalls, notes: row.notes || '', maxHR: row.maxHR || '', recallsCount: row.recallsCount || 0
      }));
      const jsonStr = JSON.stringify(payload, null, 2);
      const blob = new Blob([jsonStr], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      const ts = new Date().toISOString().replace(/[:.]/g, '-');
      a.href = url; a.download = `fsa_table_${ts}.json`; document.body.appendChild(a); a.click();
      document.body.removeChild(a); URL.revokeObjectURL(url);
      log(`Saved ${rowsAll.length} row(s) to JSON.`);
    }

    function loadTable() {
      const input = document.createElement('input');
      input.type = 'file'; input.accept = '.json,application/json';
      input.addEventListener('change', (e) => {
        const file = e.target.files[0]; if (!file) return;
        setLoading(file.name, 0);
        const reader = new FileReader();
        reader.onprogress = (ev) => { if (ev.lengthComputable) setLoading(file.name, (ev.loaded / ev.total) * 100); };
        reader.onload = (ev) => {
          try {
            const jsonData = JSON.parse(ev.target.result);
            if (Array.isArray(jsonData)) {
              rowsAll = jsonData; filteredRows = null; recallFilterValue = '';
              applyRecallInfoToRows();
              renderTable(); log(`Loaded ${jsonData.length} rows from JSON file.`); logStatistics();
            } else { log('Invalid JSON format: expected array of rows.'); }
          } catch (err) { console.error(err); log('Error loading JSON file (see console).'); }
        };
        reader.onloadend = () => clearLoading();
        reader.readAsText(file);
      });
      input.click();
    }

    function clearAllData() {
      rowsAll = []; filteredRows = null; recallFilterValue = '';
      renderTable(); log('Cleared all table data.');
    }

    function killByNameSubstring(substring) {
      syncTableEditsToRowsAll();
      const needle = (substring || '').trim().toUpperCase();
      if (!needle) { log('Kill name: no name substring provided.'); return; }
      const before = rowsAll.length;
      rowsAll = rowsAll.filter(row => !(row.fullName || '').toUpperCase().includes(needle));
      const removed = before - rowsAll.length;
      filteredRows = null; recallFilterValue = '';
      log(`Kill name "${substring}": removed ${removed} row(s).`); renderTable();
    }

    async function loadMailerTemplateFromTxt(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        setLoading(file.name, 0);
        reader.onprogress = (e) => { if (e.lengthComputable) setLoading(file.name, (e.loaded / e.total) * 100); };
        reader.onload = (e) => { try { resolve(e.target.result || ''); } catch (err) { reject(err); } };
        reader.onerror = (e) => reject(e);
        reader.onloadend = () => clearLoading();
        reader.readAsText(file);
      });
    }

    function buildMailBodyForRow(template, row) {
      const veh = row.yrModel || '';
      const fullName = row.fullName || '';
      const recalls = row.recalls || '';
      const vin = row.vinFull || '';
      return template.replace(/<vin>/gi, vin).replace(/<veh>/gi, veh).replace(/<name>/gi, fullName).replace(/<recalls>/gi, recalls);
    }
    function normalizeAddressForPdf(address) {
      if (!address) return '';
      const [main, tag] = address.split('|').map(s => s.trim());
      return main || tag || '';
    }

    async function buildSnailer() {
      if (!mailerTemplateText) { alert('Must load what to send before building'); return; }
      const { jsPDF } = window.jspdf; if (!jsPDF) { log('jsPDF not available; cannot generate snail-mail PDF.'); return; }
      syncTableEditsToRowsAll();
      const rowsToMail = rowsAll.filter(row => (row.address || '').trim().length > 0);
      if (!rowsToMail.length) { log('Build snailer: no rows with valid address.'); return; }

      const doc = new jsPDF({ unit: 'pt', format: 'letter' });
      const marginLeft = 40, marginTop = 72, lineHeight = 14;
      let currentY = marginTop;
      const sentRecords = []; let pagesBuilt = 0;

      rowsToMail.forEach((row, index) => {
        if (index > 0) { doc.addPage(); currentY = marginTop; pagesBuilt++; }
        const address = normalizeAddressForPdf(row.address);
        const [nameLine, cityStateZip] = address.split(',').map(s => s.trim());

        doc.setFont('Times', 'Normal'); doc.setFontSize(12);
        let lineY = currentY;
        if (nameLine) { doc.text(nameLine, marginLeft, lineY); lineY += lineHeight; }
        if (cityStateZip) { doc.text(cityStateZip, marginLeft, lineY); lineY += lineHeight; }

        const body = buildMailBodyForRow(mailerTemplateText, row);
        const bodyLines = doc.splitTextToSize(body, 520);
        lineY += lineHeight * 1.5; doc.text(bodyLines, marginLeft, lineY);

        sentRecords.push({ vin: row.vinFull, name: row.fullName, address, recalls: row.recalls, notes: row.notes || '' });
        if (!row.notes) row.notes = '';
        const timestamp = new Date().toLocaleString();
        row.notes += (row.notes ? ' / ' : '') + `Part of snailer built: ${timestamp}`;
        currentY = marginTop;
      });
      pagesBuilt++; const ts = new Date().toISOString().slice(0, 19).replace(/[:T]/g, '-');
      const filename = `snailer_${ts}.pdf`; doc.save(filename);
      renderTable();

      const jsonStr = JSON.stringify(sentRecords, null, 2);
      const blob = new Blob([jsonStr], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = `snailer_sent_${ts}.json`;
      document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
      log(`Built: ${pagesBuilt} pages\nSaved to: ${filename}`);
    }

    function fireEmailList() {
      if (!rowsAll || !rowsAll.length) { log('Fire email list: no rows loaded.'); return; }
      syncTableEditsToRowsAll();
      const exportRows = rowsAll.filter(row => (row.emailStr || '').trim().length > 0);
      if (!exportRows.length) { log('Fire email list: no rows with an email address found.'); return; }
      const payload = exportRows.map(row => ({
        vin: row.vinFull, yrModel: row.yrModel, name: row.fullName, phone: row.phoneStr,
        email: row.emailStr, address: row.address, recalls: row.recalls, notes: row.notes || ''
      }));
      const jsonStr = JSON.stringify(payload, null, 2);
      const blob = new Blob([jsonStr], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); const ts = new Date().toISOString().replace(/[:.]/g, '-');
      a.href = url; a.download = `email_list_${ts}.json`;
      document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
      log(`Fire email list: saved ${exportRows.length} row(s) with emails to JSON.`);
    }

    function applyRecallFilter() {
      const input = document.getElementById('recall-filter-input'); if (!input) { log('Recall filter input not found.'); return; }
      const val = (input.value || '').trim(); if (!val) { resetRecallFilter(); return; }
      recallFilterValue = val.toUpperCase();
      filteredRows = rowsAll.filter(row => (row.recalls || '').toUpperCase().includes(recallFilterValue));
      renderTable();
      const removed = rowsAll.length - filteredRows.length;
      log(`Recall filter "${val}" applied. Kept ${filteredRows.length} rows, removed ${removed}.`);
    }
    function resetRecallFilter() {
      recallFilterValue = ''; filteredRows = null;
      const input = document.getElementById('recall-filter-input'); if (input) input.value = '';
      renderTable(); log('Removed filter.  Table reset.')
    }

    function showGeoGroups() {
      syncTableEditsToRowsAll();
      const map = new Map();
      rowsAll.forEach(row => {
        const addr = (row.address || '').trim(); if (!addr) return;
        const zipMatch = addr.match(/(\d{5})(?:-\d{4})?$/); if (!zipMatch) return;
        const zip = zipMatch[1];
        let entry = map.get(zip); if (!entry) { entry = { zip, rows: [] }; map.set(zip, entry); }
        entry.rows.push(row);
      });
      const list = Array.from(map.values());
      list.sort((a, b) => (b.rows.length !== a.rows.length) ? b.rows.length - a.rows.length : a.zip.localeCompare(b.zip));
      const sortedRows = []; list.forEach(entry => entry.rows.forEach(row => sortedRows.push(row)));
      filteredRows = sortedRows; recallFilterValue = '[ZIP]'; renderTable();
    }

    // NEW: Importers
    function readSheetFromFile(file, onRows) {
      const lower = file.name.toLowerCase();
      setLoading(file.name, 0);
      if (lower.endsWith('.csv')) {
        const reader = new FileReader();
        reader.onprogress = (e) => { if (e.lengthComputable) setLoading(file.name, (e.loaded / e.total) * 100); };
        reader.onload = (e) => { try { onRows(parseCsvText(e.target.result)); } catch (err) { console.error(err); log('Import error: CSV parse failed.'); } };
        reader.onloadend = () => clearLoading();
        reader.readAsText(file);
      } else {
        if (typeof XLSX === 'undefined') { log('Import error: XLSX lib not available.'); clearLoading(); return; }
        const reader = new FileReader();
        reader.onprogress = (e) => { if (e.lengthComputable) setLoading(file.name, (e.loaded / e.total) * 100); };
        reader.onload = (e) => {
          try {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, { type: 'array' });
            const firstSheetName = workbook.SheetNames[0];
            const worksheet = workbook.Sheets[firstSheetName];
            const rows = XLSX.utils.sheet_to_json(worksheet, { header: 1, defval: '' });
            onRows(rows);
          } catch (err) { console.error(err); log('Import error: Excel read failed.'); }
        };
        reader.onloadend = () => clearLoading();
        reader.readAsArrayBuffer(file);
      }
    }

    function importPhone(file) {
      log(`Import Phone: loading "${file.name}"...`);
      readSheetFromFile(file, (sheetRows) => {
        const vinToPhone = new Map();
        const vinToName = new Map();
        sheetRows.forEach((row, idx) => {
          if (!row) return;
          const cells = Array.isArray(row) ? row : Object.values(row);
          const firstCell = String(cells[0] || '').trim().toUpperCase();
          if (idx === 0 && (firstCell.includes('VIN') || firstCell.includes('CUSTOMER'))) return;

          // VIN col D (index 3)
          let vin = '';
          if (cells.length > 3) {
            const vinCell = String(cells[3] || '').trim().toUpperCase();
            const clean = vinCell.replace(/[^A-Z0-9]/g, '');
            if (/^[A-HJ-NPR-Z0-9]{10,17}$/.test(clean)) vin = clean.slice(-17);
          }
          if (!vin) return;

          // Phone col B (index 1)
          let phone = '';
          if (cells.length > 1) {
            const raw = String(cells[1] || '').trim();
            const digits = (raw.match(/\d/g) || []).length;
            if (digits > 5) phone = raw;
          }
          if (!phone) return;

          // Name col A (index 0)
          let name = '';
          if (cells.length > 0) {
            const raw = String(cells[0] || '').trim();
            if (raw) name = raw;
          }

          const existingPhone = vinToPhone.get(vin) || '';
          vinToPhone.set(vin, existingPhone ? `${existingPhone} / ${phone}` : phone);

          if (name) {
            const existingName = vinToName.get(vin) || '';
            if (!existingName) vinToName.set(vin, name); // keep first non-empty name from sheet
          }
        });

        syncTableEditsToRowsAll();
        let matches = 0, phonesAdded = 0, namesUpdated = 0;
        rowsAll.forEach(row => {
          const vinKey = row.vinFull.toUpperCase().replace(/[^A-Z0-9]/g, '').slice(-17);
          const phone = vinToPhone.get(vinKey); if (phone) {
            matches++;
            const current = row.phoneStr || '';
            if (!current.includes(phone)) {
              row.phoneStr = current ? `${current} / ${phone}` : phone;
              phonesAdded++;
            }
          }
          const nameFromSheet = vinToName.get(vinKey);
          if (nameFromSheet) {
            // REPLACE current name (not append) with name from sheet's col A
            if ((row.fullName || '') !== nameFromSheet) {
              row.fullName = nameFromSheet;
              row.hasName = !!nameFromSheet;
              namesUpdated++;
            }
          }
        });
        renderTable();
        log(`Import Phone: matched ${matches} VINs. Added ${phonesAdded} phone entrie(s). Updated phones: ${phonesAdded} Updated names: ${namesUpdated}.`);
      });
    }

    function importEmail(file) {
      log(`Import Email: loading "${file.name}"...`);
      readSheetFromFile(file, (sheetRows) => {
        const vinToEmail = new Map();
        sheetRows.forEach((row, idx) => {
          if (!row) return;
          const cells = Array.isArray(row) ? row : Object.values(row);
          const firstCell = String(cells[0] || '').trim().toUpperCase();
          if (idx === 0 && (firstCell.includes('VIN') || firstCell.includes('CUSTOMER'))) return;

          // VIN col D
          let vin = '';
          if (cells.length > 3) {
            const vinCell = String(cells[3] || '').trim().toUpperCase();
            const clean = vinCell.replace(/[^A-Z0-9]/g, '');
            if (/^[A-HJ-NPR-Z0-9]{10,17}$/.test(clean)) vin = clean.slice(-17);
          }
          if (!vin) return;

          // Email col E
          let email = '';
          if (cells.length > 4) {
            const raw = String(cells[4] || '').trim();
            if (raw.includes('@')) email = raw;
          }
          if (!email) return;

          const existing = vinToEmail.get(vin) || '';
          vinToEmail.set(vin, existing ? `${existing} / ${email}` : email);
        });

        syncTableEditsToRowsAll();
        let matches = 0, emailsAdded = 0;
        rowsAll.forEach(row => {
          const vinKey = row.vinFull.toUpperCase().replace(/[^A-Z0-9]/g, '').slice(-17);
          const email = vinToEmail.get(vinKey); if (!email) return;
          matches++;
          const current = row.emailStr || '';
          if (!current.includes(email)) {
            row.emailStr = current ? `${current} / ${email}` : email;
            emailsAdded++;
          }
        });
        renderTable();
        log(`Import Email: matched ${matches} VINs. Added ${emailsAdded} email entrie(s).`);
      });
    }

    function populateRecallListFromJson(json) {
      const container = document.getElementById('recall-list');
      if (!container) return;
      container.innerHTML = '';
      if (!Array.isArray(json)) return;
      const codes = [];
      json.forEach(item => {
        if (!item) return;
        const code = String(item.recall || '').trim();
        if (code) codes.push(code.toUpperCase());
      });
      const unique = Array.from(new Set(codes)).sort();
      unique.forEach(code => {
        const btn = document.createElement('div');
        btn.className = 'recall-item';
        btn.textContent = code;
        btn.addEventListener('click', () => {
          // find rows that include this recall code and scroll to first
          const targetCode = code.toUpperCase();
          const matchingIdx = rowsAll.findIndex(r => ((r.recalls || '').toUpperCase().split('/').map(s => s.trim()).indexOf(targetCode) !== -1));
          if (matchingIdx === -1) {
            log(`No rows found containing recall ${code}.`);
            return;
          }
          // ensure table is rendered and not filtered
          filteredRows = null;
          renderTable();
          const tbody = document.getElementById('table-body');
          const rows = Array.from(tbody.querySelectorAll('tr'));
          const tr = rows[matchingIdx];
          if (tr) {
            tr.scrollIntoView({ behavior: 'smooth', block: 'center' });
            tr.classList.add('row-highlight');
            setTimeout(() => tr.classList.remove('row-highlight'), 2200);
            // attempt to set maxHR for that row from recall info if available
            applyRecallInfoToRows();
            renderTable();
            log(`Jumped to first row with recall ${code}.`);
          } else {
            log(`Matching row found but could not scroll (index ${matchingIdx}).`);
          }
        });
        container.appendChild(btn);
      });
    }

    function importRecallInfo(file) {
      log(`Import recall info: loading "${file.name}"...`);
      setLoading(file.name, 0);
      const reader = new FileReader();
      reader.onprogress = (e) => { if (e.lengthComputable) setLoading(file.name, (e.loaded / e.total) * 100); };
      reader.onload = (e) => {
        try {
          const json = JSON.parse(e.target.result);
          window.recallInfoCache = json; // kept for later use
          populateRecallListFromJson(json);
          // apply to rows as best-effort
          applyRecallInfoToRows();
          renderTable();
          const count = Array.isArray(json) ? json.length : (json && typeof json === 'object' ? Object.keys(json).length : 1);
          log(`Loaded ${count} recall descriptions.`);
        } catch (err) {
          console.error(err);
          log('Import recall info: invalid JSON.');
        }
      };
      reader.onloadend = () => clearLoading();
      reader.readAsText(file);
    }

    // Events
    document.addEventListener('DOMContentLoaded', () => {
      const loadXlsBtn = document.getElementById('load-xls-btn');
      const clearAllBtn = document.getElementById('clear-all-btn');
      const killDupsBtn = document.getElementById('kill-dups-btn');
      const saveTableBtn = document.getElementById('save-table-btn');
      const loadTableBtn = document.getElementById('load-table-btn');
      const loadMailerTxtBtn = document.getElementById('load-mailer-txt-btn');
      const buildSnailerBtn = document.getElementById('build-snailer-btn');
      const killLkqBtn = document.getElementById('kill-lkq-btn');
      const clearLogBtn = document.getElementById('clear-log-btn');
      const logSaveBtn = document.getElementById('log-save-btn');
      const logLoadBtn = document.getElementById('log-load-btn');
      const applyRecallFilterBtn = document.getElementById('apply-recall-filter-btn');
      const resetRecallFilterBtn = document.getElementById('reset-recall-filter-btn');
      const recallFilterInput = document.getElementById('recall-filter-input');
      const geoGroupsBtn = document.getElementById('geo-groups-btn');
      const fireEmailListBtn = document.getElementById('fire-email-list-btn');

      // NEW import controls
      const importPhoneBtn = document.getElementById('import-phone-btn');
      const importPhoneInput = document.getElementById('import-phone-input');
      const importEmailBtn = document.getElementById('import-email-btn');
      const importEmailInput = document.getElementById('import-email-input');
      const importRecallBtn = document.getElementById('import-recall-btn');
      const importRecallInput = document.getElementById('import-recall-input');

      // Loader for main FSA list
      const fileInput = document.createElement('input');
      fileInput.type = 'file';
      fileInput.accept = '.csv,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet,application/vnd.ms-excel';
      fileInput.addEventListener('change', (e) => {
        const file = e.target.files[0]; if (!file) return;
        log(`Loading file: ${file.name}`); handleFile(file); e.target.value = '';
      });

      const mailerTxtInput = document.getElementById('mailer-txt-input');

      if (loadXlsBtn) loadXlsBtn.addEventListener('click', () => fileInput.click());
      if (clearAllBtn) clearAllBtn.addEventListener('click', clearAllData);
      if (killDupsBtn) killDupsBtn.addEventListener('click', killDuplicates);
      if (saveTableBtn) saveTableBtn.addEventListener('click', saveTable);
      if (loadTableBtn) loadTableBtn.addEventListener('click', loadTable);

      if (loadMailerTxtBtn && mailerTxtInput) {
        loadMailerTxtBtn.addEventListener('click', () => mailerTxtInput.click());
        mailerTxtInput.addEventListener('change', async (evt) => {
          const file = evt.target.files[0]; if (!file) return;
          log(`Loading mailer TXT template "${file.name}"...`);
          try { mailerTemplateText = await loadMailerTemplateFromTxt(file); log('Mailer TXT template loaded. Ready to "Build snailer".'); buildSnailerBtn.disabled = false; }
          catch (err) { console.error(err); log('Error loading mailer TXT template.'); }
          finally { evt.target.value = ''; }
        });
      }
      if (buildSnailerBtn) buildSnailerBtn.addEventListener('click', buildSnailer);

      if (killLkqBtn) {
        const killNameInput = document.getElementById('kill-name-input');
        killLkqBtn.addEventListener('click', () => {
          const name = killNameInput.value || 'LKQ CORPORATION'; killByNameSubstring(name);
        });
      }

      if (clearLogBtn) clearLogBtn.addEventListener('click', clearLog);
      if (logSaveBtn) logSaveBtn.addEventListener('click', saveLog);
      if (logLoadBtn) logLoadBtn.addEventListener('click', loadLog);

      if (applyRecallFilterBtn) applyRecallFilterBtn.addEventListener('click', applyRecallFilter);
      if (resetRecallFilterBtn) resetRecallFilterBtn.addEventListener('click', resetRecallFilter);
      if (recallFilterInput) recallFilterInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') { e.preventDefault(); applyRecallFilter(); } });

      if (geoGroupsBtn) geoGroupsBtn.addEventListener('click', showGeoGroups);
      if (fireEmailListBtn) fireEmailListBtn.addEventListener('click', fireEmailList);

      // NEW: phone importer
      if (importPhoneBtn && importPhoneInput) {
        importPhoneBtn.addEventListener('click', () => importPhoneInput.click());
        importPhoneInput.addEventListener('change', (evt) => {
          const file = evt.target.files[0]; if (!file) return;
          importPhone(file); evt.target.value = '';
        });
      }
      // NEW: email importer
      if (importEmailBtn && importEmailInput) {
        importEmailBtn.addEventListener('click', () => importEmailInput.click());
        importEmailInput.addEventListener('change', (evt) => {
          const file = evt.target.files[0]; if (!file) return;
          importEmail(file); evt.target.value = '';
        });
      }
      // NEW: recall info loader (JSON only)
      if (importRecallBtn && importRecallInput) {
        importRecallBtn.addEventListener('click', () => importRecallInput.click());
        importRecallInput.addEventListener('change', (evt) => {
          const file = evt.target.files[0]; if (!file) return;
          importRecallInfo(file); evt.target.value = '';
        });
      }

      // initial UI state
      log('Ready. Upload an XLS/CSV file to build the table, or load mailer / import phone / import email / import recall info.');
      updateDataPills();
      updateLastChangeTimestamp();
    });
  </script>
</body>
</html>